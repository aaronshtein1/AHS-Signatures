generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// PDF Template uploaded by admin
model Template {
  id           String   @id @default(uuid())
  name         String
  description  String?
  fileName     String
  filePath     String
  placeholders Json     // Array of detected placeholders
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  packets      SigningPacket[]
}

// A signing packet created from a template
model SigningPacket {
  id              String   @id @default(uuid())
  name            String
  templateId      String
  template        Template @relation(fields: [templateId], references: [id])
  status          String   @default("draft") // draft, sent, in_progress, completed, cancelled
  signedPdfPath   String?  // Path to final signed PDF
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  completedAt     DateTime?
  recipients      Recipient[]
  auditLogs       AuditLog[]
}

// A recipient/signer for a packet
model Recipient {
  id            String   @id @default(uuid())
  packetId      String
  packet        SigningPacket @relation(fields: [packetId], references: [id], onDelete: Cascade)
  roleName      String   // matches placeholder role
  name          String
  email         String
  order         Int      // signing order (1, 2, 3...)
  status        String   @default("pending") // pending, notified, signed, skipped
  token         String   @unique // secure signing token
  tokenExpiresAt DateTime
  signedAt      DateTime?
  signature     Signature?
  auditLogs     AuditLog[]

  @@index([token])
}

// Stored signature data
model Signature {
  id            String   @id @default(uuid())
  recipientId   String   @unique
  recipient     Recipient @relation(fields: [recipientId], references: [id], onDelete: Cascade)
  signatureData String   // Base64 image data or typed text
  signatureType String   // "drawn" or "typed"
  typedName     String?  // Name typed by signer
  textFields    Json?    // Any additional text field values
  ipAddress     String?
  userAgent     String?
  createdAt     DateTime @default(now())
}

// Audit log for tracking events
model AuditLog {
  id          String   @id @default(uuid())
  packetId    String
  packet      SigningPacket @relation(fields: [packetId], references: [id], onDelete: Cascade)
  recipientId String?
  recipient   Recipient? @relation(fields: [recipientId], references: [id], onDelete: SetNull)
  action      String   // created, sent, viewed, signed, completed, resent, etc.
  details     String?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())
}
