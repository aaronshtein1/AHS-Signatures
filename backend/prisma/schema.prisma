generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Admin/staff users who can create and manage signing packets
model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  name         String
  role         String   @default("user") // "admin" or "user"
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  lastLoginAt  DateTime?

  @@index([email])
}

// A signing packet with its own uploaded PDF document
model SigningPacket {
  id              String   @id @default(uuid())
  name            String
  fileName        String   // Original uploaded file name
  filePath        String   // Storage path: packets/{id}/{filename}
  placeholders    String   // JSON string of detected placeholders
  status          String   @default("draft") // draft, sent, in_progress, completed, cancelled
  signedPdfPath   String?  // Path to final signed PDF
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  completedAt     DateTime?
  recipients      Recipient[]
  auditLogs       AuditLog[]
}

// A recipient/signer for a packet
model Recipient {
  id            String   @id @default(uuid())
  packetId      String
  packet        SigningPacket @relation(fields: [packetId], references: [id], onDelete: Cascade)
  roleName      String   // matches placeholder role
  name          String
  email         String
  order         Int      // signing order (1, 2, 3...)
  status        String   @default("pending") // pending, notified, signed, skipped
  token         String   @unique // secure signing token
  tokenExpiresAt DateTime
  signedAt      DateTime?
  signature     Signature?
  auditLogs     AuditLog[]

  @@index([token])
}

// Stored signature data
model Signature {
  id            String   @id @default(uuid())
  recipientId   String   @unique
  recipient     Recipient @relation(fields: [recipientId], references: [id], onDelete: Cascade)
  signatureData String   // Base64 image data or typed text
  signatureType String   // "drawn" or "typed"
  typedName     String?  // Name typed by signer
  textFields    String?  // JSON string of additional text field values
  ipAddress     String?
  userAgent     String?
  createdAt     DateTime @default(now())
}

// Audit log for tracking events
model AuditLog {
  id          String   @id @default(uuid())
  packetId    String
  packet      SigningPacket @relation(fields: [packetId], references: [id], onDelete: Cascade)
  recipientId String?
  recipient   Recipient? @relation(fields: [recipientId], references: [id], onDelete: SetNull)
  action      String   // created, sent, viewed, signed, completed, resent, etc.
  details     String?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())
}
